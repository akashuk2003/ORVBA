{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Request #{{ req.id }}</h5>
            </div>
            <div class="card-body">
                <p><strong>Customer:</strong> {{ req.customer.username }}</p>
                <p><strong>Location:</strong> {{ req.address|default:"GPS Coordinates Only" }}</p>
                <p><strong>Service:</strong> {{ req.service_type }}</p>
                <p><strong>Status:</strong> 
                    <span class="badge bg-{{ req.status|lower }}">{{ req.status }}</span>
                </p>
                <p><strong>Phone:</strong> <a href="tel:{{ req.customer.phone_number }}">{{ req.customer.phone_number }}</a></p>
                
                <hr>
                
                <form method="post">
                    {% csrf_token %}
                    {% if req.status == 'Pending' %}
                        <button type="submit" name="action" value="accept" class="btn btn-success w-100">
                            Accept Job
                        </button>
                    {% elif req.status == 'Accepted' %}
                        <button type="submit" name="action" value="complete" class="btn btn-primary w-100 mb-2">
                            Mark Completed
                        </button>
                        <a href="https://www.google.com/maps/search/?api=1&query={{ req.latitude }},{{ req.longitude }}" target="_blank" class="btn btn-outline-secondary w-100">
                            Open in Google Maps App
                        </a>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div id="map" style="height: 500px; width: 100%; border-radius: 10px; border: 2px solid #ddd;"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // 1. Get Coordinates from Django
    var lat = {{ req.latitude }};
    var lng = {{ req.longitude }};

    // 2. Initialize the Map
    // 'map' refers to the id of the div above
    var map = L.map('map').setView([lat, lng], 15); // 15 is the zoom level

    // 3. Add the OpenStreetMap Tiles (The visual map images)
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // 4. Add a Marker at the Customer's location
    var marker = L.marker([lat, lng]).addTo(map);

    // 5. Add a Popup (Tooltip)
    marker.bindPopup("<b>Customer Location</b><br>{{ req.customer.username }} is here.").openPopup();
</script>
{% endblock %}